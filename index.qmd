---
title: "Hands-on Survival Analysis with an deidentified Thyroid Cancer Dataset"
description: "익명화된 자료로 연습하기"
author: "RPythonStudyGroup feat. ChatGPT"
date: "2025-02-03"
date-modified: "2025-02-03"
categories:
  - R
  - Survival
  - hands-on
---

### readRDS

-   R에서만 사용하는 자료형태인 RDS를 자료형이 보전되어 빠르게 읽어옴

```{r rai_recur}

library(dplyr)

rai_recur <- readRDS("deidentified_data/rai_recur.rds")
```

### mytable
-   mytable로 자료 개요 파악
- LaTex 출력은 성공하지 못함.

```{r mytable}

library(moonBook)

# mytable(recur~.,data=rai_recur) %>% mylatex() %>% cat # 정상작동이 되지 않는 이유는?

mytable(recur~.,data=rai_recur)
```

### Surv함수

-   time과 event를 인자로 받아 특수한 형태의 matrix인 생존(survival) 객체 반환

```{r Surv}

library(survival)

rai_recur$recur <- as.integer(rai_recur$recur)
km <- Surv(rai_recur$time, event = rai_recur$recur) ## default type : "right"
# km <- Surv(time=time, event = recur, data=rai_recur) # data= 형식을 지원하지 않음

str(km)
```

```{r head}

head(km)
```

-   plot() 함수는 제네릭 함수로, 기본적으로 산점도를 그리지만, Surv 객체를 인자로 받으면 내부적으로 plot.survfit() 메서드를 호출하여 Kaplan-Meier(KM) 곡선을 반환함

```{r plot.survfit}

plot(km) ## km - Surv class (time, status) 가지고 있는 리스트
```

-   **survfit 함수의 인자**로 사용되므로 중요

#### \*\* 중앙생존시간 및 평균생존시간

```{r median}

median(km)  ## Surv 객체에 대한 method 함수들이 있다.
```

```{r mean}

mean(km)
```

### survfit함수와 객체

-   Surv 객체와 공변량을 formula 형태의 인자로 받아 Kaplan-Meier 또는 Cox 모델 기반 생존 확률을 저장한 객체를 반환

```{r plot_survfit}

plot(survfit(km~1)) #Kaplan-Meier 기반
```

```{r plot_cox}

km_fit <- survfit(km~rai_recur$sex) #cox model 기반

plot(km_fit)
```

```{r summary1}
summary(km_fit) 
```

```{r summary2}
summary(km_fit, c(365*1:19)) ### 정해진 time에 맞는 생존테이블표를 만든다.
```

```{r plot_cox}
plot(km_fit, col = rainbow(2), lty=1:2)
legend("topright", legend = c("Female","Male"),
col= rainbow(2), lty=1:2)
```

```{r ggsurvplot}

library(survminer)

ggsurvplot(
  km_fit, 
  data = rai_recur,
  conf.int = T, 
  xscale = 365.2425, ## xscale can be "d_y"
  break.x.by = 5*365.2425,
  pval = T, 
  pval.size =4, 
  surv.median.line = "hv",
  risk.table = FALSE, ## if TRUE, risk table is displayed under graph
  legend.title="sex", 
  legend.labs=c("Female","Male"),
  palette = c("#E7B800", "#2E9FDF"),
)
```
